#!/bin/bash

function usage {
cat << EOF
Converts BNC XML files to plaintext and extracts gold standard sentence boundaries.

Usage: `basename $0` XMLDIR FILELIST PLNDIR BOUNDSDIR

    XMLDIR     directory where BNC XML files are stored
    FILELIST   file containing relative paths to BNC XML files
               (generated by getfilelist.sh)
    PLNDIR     directory to write plaintext files to
    BOUNDSDIR  directory to write extracted sentence boundaries to
EOF
}

xmlDir=$1
xmlFileList=$2
plaindir=$3
boundsdir=$4
if [ -z $xmlDir ] || [ -z $xmlFileList ] || [ -z $plaindir ] || [ -z $boundsdir ]; then
    usage
    exit
fi

errfile=plaintexterror.log

cat << EOF
Preprocessing BNC texts.
  XML texts in: $xmlDir
  Extracting plaintext to: $plaindir
  Extracting bounds to: $boundsdir

Working...

EOF

rm $errfile

counter=0
errcounter=0
skipcounter=0
plncounter=0
for f in `cat $xmlFileList`
do
    fn=`basename $f`

    cp $xmlDir/$f $plaindir/
    # strip newlines
    tmpf=$plaindir/${fn}.tmp
    tr -d "\n" < $plaindir/$fn > $tmpf

    # and convert to plaintext
    python plaintext.py $tmpf "$plaindir/{0}_${fn}.txt" "$boundsdir/{0}_${fn}.txt.bounds.{1}" 2>> $errfile
    result=$?
    if [ $result -eq 1 ]; then
        errcounter=$((errcounter + 1))
    elif [ $result -eq 2 ]; then
        skipcounter=$((skipcounter + 1))
    else
        plncounter=$((plncounter + 1))
    fi

    counter=$((counter + 1))
    echo -ne "Processed: $counter\tPlaintext: $plncounter\tSkipped: $skipcounter\tError: $errcounter\r"

    rm $tmpf $plaindir/$fn
done

echo; echo Done! Processed $counter total files.
echo "  Converted: $plncounter; Skipped: $skipcounter; Error: $errcounter"
echo "  Any errors were logged to `pwd`/$errfile".
